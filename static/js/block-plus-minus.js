/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
// xiaohong2022 modified several places and re-confused the code.
!function(){var h=h||{};h.scope={};h.arrayIteratorImpl=function(f){var g=0;return function(){return g<f.length?{done:!1,value:f[g++]}:{done:!0}}};h.arrayIterator=function(f){return{next:h.arrayIteratorImpl(f)}};h.makeIterator=function(f){var g="undefined"!=typeof Symbol&&Symbol.iterator&&f[Symbol.iterator];return g?g.call(f):h.arrayIterator(f)};!function(){function f(a){return a.saveExtraState?(a=a.saveExtraState())?JSON.stringify(a):"":a.mutationToDom?(a=a.mutationToDom())?Blockly.Xml.domToText(a):"":""}function g(a){var b=new Blockly.FieldImage("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTggMTFoLTEyYy0xLjEwNCAwLTIgLjg5Ni0yIDJzLjg5NiAyIDIgMmgxMmMxLjEwNCAwIDItLjg5NiAyLTJzLS44OTYtMi0yLTJ6IiBmaWxsPSJ3aGl0ZSIgLz48L3N2Zz4K",15,15,void 0,p);b.args_=a;return b}function p(a){var b=a.getSourceBlock();if(!b.isInFlyout){Blockly.Events.setGroup(!0);var c=f(b);b.minus(a.args_);a=f(b);c!=a&&Blockly.Events.fire(new Blockly.Events.BlockChange(b,"mutation",null,c,a));Blockly.Events.setGroup(!1)}}function m(a){var b=new Blockly.FieldImage("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTggMTBoLTR2LTRjMC0xLjEwNC0uODk2LTItMi0ycy0yIC44OTYtMiAybC4wNzEgNGgtNC4wNzFjLTEuMTA0IDAtMiAuODk2LTIgMnMuODk2IDIgMiAybDQuMDcxLS4wNzEtLjA3MSA0LjA3MWMwIDEuMTA0Ljg5NiAyIDIgMnMyLS44OTYgMi0ydi00LjA3MWw0IC4wNzFjMS4xMDQgMCAyLS44OTYgMi0ycy0uODk2LTItMi0yeiIgZmlsbD0id2hpdGUiIC8+PC9zdmc+Cg==",15,15,void 0,q);b.args_=a;return b}function q(a){var b=a.getSourceBlock();if(!b.isInFlyout){Blockly.Events.setGroup(!0);var c=f(b);b.plus(a.args_);a=f(b);c!=a&&Blockly.Events.fire(new Blockly.Events.BlockChange(b,"mutation",null,c,a));Blockly.Events.setGroup(!1)}}!function(){Blockly.Extensions.isRegistered("controls_if_mutator")&&Blockly.Extensions.unregister("controls_if_mutator");Blockly.Extensions.registerMutator("controls_if_mutator",{elseIfCount_:0,hasElse_:!1,mutationToDom:function(){if(!this.elseIfCount_&&!this.hasElse_)return null;var a=Blockly.utils.xml.createElement("mutation");a.setAttribute("elseif",this.elseIfCount_);this.hasElse_&&a.setAttribute("else",1);return a},domToMutation:function(a){var b=parseInt(a.getAttribute("elseif"),10)||0;(this.hasElse_=!!parseInt(a.getAttribute("else"),10)||0)&&!this.getInput("ELSE")&&this.appendStatementInput("ELSE").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSE);this.updateShape_(b)},saveExtraState:function(){if(!this.elseIfCount_&&!this.hasElse_)return null;var a=Object.create(null);this.elseIfCount_&&(a.elseIfCount=this.elseIfCount_);this.hasElse_&&(a.hasElse=!0);return a},loadExtraState:function(a){var b=a.elseIfCount||0;(this.hasElse_=a.hasElse||!1)&&!this.getInput("ELSE")&&this.appendStatementInput("ELSE").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSE);this.updateShape_(b)},updateShape_:function(a){for(;this.elseIfCount_<a;)this.addElseIf_();for(;this.elseIfCount_>a;)this.removeElseIf_()},plus:function(){this.addElseIf_()},minus:function(a){0!=this.elseIfCount_&&this.removeElseIf_(a)},addElseIf_:function(){this.elseIfCount_++;this.appendValueInput("IF"+this.elseIfCount_).setCheck("Boolean").appendField(Blockly.Msg.CONTROLS_IF_MSG_ELSEIF).appendField(g(this.elseIfCount_),"MINUS"+this.elseIfCount_);this.appendStatementInput("DO"+this.elseIfCount_).appendField(Blockly.Msg.CONTROLS_IF_MSG_THEN);this.getInput("ELSE")&&this.moveInputBefore("ELSE",null)},removeElseIf_:function(a){if(void 0!==a&&a!=this.elseIfCount_){a*=2;var b=this.inputList,c=b[a].connection;c.isConnected()&&c.disconnect();c=b[a+1].connection;c.isConnected()&&c.disconnect();this.bumpNeighbours();for(a+=2;(b=this.inputList[a])&&"ELSE"!=b.name;a++)(b=b.connection.targetConnection)&&this.inputList[a-2].connection.connect(b)}this.removeInput("IF"+this.elseIfCount_);this.removeInput("DO"+this.elseIfCount_);this.elseIfCount_--}},function(){this.getInput("IF0").insertFieldAt(0,m(),"PLUS")})}();!function(){delete Blockly.Blocks.lists_create_with;Blockly.defineBlocksWithJsonArray([{type:"lists_create_with",message0:"%{BKY_LISTS_CREATE_EMPTY_TITLE} %1",args0:[{type:"input_dummy",name:"EMPTY"}],output:"Array",style:"list_blocks",helpUrl:"%{BKY_LISTS_CREATE_WITH_HELPURL}",tooltip:"%{BKY_LISTS_CREATE_WITH_TOOLTIP}",mutator:"new_list_create_with_mutator"}]);Blockly.Extensions.registerMutator("new_list_create_with_mutator",{itemCount_:0,mutationToDom:function(){var a=Blockly.utils.xml.createElement("mutation");a.setAttribute("items",this.itemCount_);return a},domToMutation:function(a){a=parseInt(a.getAttribute("items"),10);this.updateShape_(a)},saveExtraState:function(){return{itemCount:this.itemCount_}},loadExtraState:function(a){this.updateShape_(a.itemCount)},updateShape_:function(a){for(;this.itemCount_<a;)this.addPart_();for(;this.itemCount_>a;)this.removePart_();this.updateMinus_()},plus:function(){this.addPart_();this.updateMinus_()},minus:function(){0!=this.itemCount_&&(this.removePart_(),this.updateMinus_())},addPart_:function(){0==this.itemCount_?(this.removeInput("EMPTY"),this.topInput_=this.appendValueInput("ADD"+this.itemCount_).appendField(m(),"PLUS").appendField(Blockly.Msg.LISTS_CREATE_WITH_INPUT_WITH)):this.appendValueInput("ADD"+this.itemCount_);this.itemCount_++},removePart_:function(){this.itemCount_--;this.removeInput("ADD"+this.itemCount_);0==this.itemCount_&&(this.topInput_=this.appendDummyInput("EMPTY").appendField(m(),"PLUS").appendField(Blockly.Msg.LISTS_CREATE_EMPTY_TITLE))},updateMinus_:function(){var a=this.getField("MINUS");!a&&0<this.itemCount_?this.topInput_.insertFieldAt(1,g(),"MINUS"):a&&1>this.itemCount_&&this.topInput_.removeField("MINUS")}},function(){this.getInput("EMPTY").insertFieldAt(0,m(),"PLUS");this.updateShape_(3)})}();!function(){delete Blockly.Blocks.procedures_defnoreturn;delete Blockly.Blocks.procedures_defreturn;Blockly.defineBlocksWithJsonArray([{type:"procedures_defnoreturn",message0:"%{BKY_PROCEDURES_DEFNORETURN_TITLE} %1 %2",message1:"%{BKY_PROCEDURES_DEFNORETURN_DO} %1",args0:[{type:"field_input",name:"NAME",text:""},{type:"input_dummy",name:"TOP"}],args1:[{type:"input_statement",name:"STACK"}],style:"procedure_blocks",helpUrl:"%{BKY_PROCEDURES_DEFNORETURN_HELPURL}",tooltip:"%{BKY_PROCEDURES_DEFNORETURN_TOOLTIP}",extensions:["get_procedure_def_no_return","procedure_context_menu","procedure_rename","procedure_vars"],mutator:"procedure_def_mutator"},{type:"procedures_defreturn",message0:"%{BKY_PROCEDURES_DEFRETURN_TITLE} %1 %2",message1:"%{BKY_PROCEDURES_DEFRETURN_DO} %1",message2:"%{BKY_PROCEDURES_DEFRETURN_RETURN} %1",args0:[{type:"field_input",name:"NAME",text:""},{type:"input_dummy",name:"TOP"}],args1:[{type:"input_statement",name:"STACK"}],args2:[{type:"input_value",align:"right",name:"RETURN"}],style:"procedure_blocks",helpUrl:"%{BKY_PROCEDURES_DEFRETURN_HELPURL}",tooltip:"%{BKY_PROCEDURES_DEFRETURN_TOOLTIP}",extensions:["get_procedure_def_return","procedure_context_menu","procedure_rename","procedure_vars"],mutator:"procedure_def_mutator"}]);Blockly.Extensions.registerMixin("get_procedure_def_no_return",{getProcedureDef:function(){var a=this.argData_.map(function(b){return b.model.name});return[this.getFieldValue("NAME"),a,!1]},callType_:"procedures_callnoreturn"});Blockly.Extensions.registerMixin("get_procedure_def_return",{getProcedureDef:function(){var a=this.argData_.map(function(b){return b.model.name});return[this.getFieldValue("NAME"),a,!0]},callType_:"procedures_callreturn"});Blockly.Extensions.registerMixin("procedure_context_menu",{customContextMenu:function(a){if(!this.isInFlyout){var b=this.getFieldValue("NAME");b=Blockly.Msg.PROCEDURES_CREATE_DO.replace("%1",b);var c=Blockly.utils.xml.createElement("block");c.setAttribute("type",this.callType_);c.appendChild(this.mutationToDom(!0));c=Blockly.ContextMenu.callbackFactory(this,c);a.push({enabled:!0,text:b,callback:c});if(!this.isCollapsed())for(b=this.getVarModels(),b=h.makeIterator(b),c=b.next();!c.done;c=b.next()){var e=c.value;c=Blockly.Msg.VARIABLES_SET_CREATE_GET.replace("%1",e.name);var d=Blockly.utils.xml.createElement("block");d.setAttribute("type","variables_get");d.appendChild(Blockly.Variables.generateVariableFieldDom(e));e=Blockly.ContextMenu.callbackFactory(this,d);a.push({enabled:!0,text:c,callback:e})}}}});Blockly.Extensions.registerMutator("procedure_def_mutator",{mutationToDom:function(a){a=void 0===a?!1:a;var b=Blockly.utils.xml.createElement("mutation");a&&b.setAttribute("name",this.getFieldValue("NAME"));this.argData_.forEach(function(c){var e=Blockly.utils.xml.createElement("arg"),d=c.model;e.setAttribute("name",d.name);e.setAttribute("varid",d.getId());e.setAttribute("argid",c.argId);a&&e.setAttribute("paramid",c.argId);b.appendChild(e)});this.hasStatements_||b.setAttribute("statements","false");return b},domToMutation:function(a){(this.hasStatements_="false"!==a.getAttribute("statements"))||this.removeInput("STACK");var b=[],c=[],e=[];a=h.makeIterator(a.childNodes);for(var d=a.next();!d.done;d=a.next())d=d.value,"arg"==d.nodeName.toLowerCase()&&(b.push(d.getAttribute("name")),c.push(d.getAttribute("varid")||d.getAttribute("varId")),e.push(d.getAttribute("argid")));this.updateShape_(b,c,e)},saveExtraState:function(){if(!this.argData_.length&&this.hasStatements_)return null;var a=Object.create(null);this.argData_.length&&(a.params=[],this.argData_.forEach(function(b){var c=b.model;a.params.push({name:c.name,id:c.getId(),argId:b.argId})}));this.hasStatements_||(a.hasStatements=!1);return a},loadExtraState:function(a){(this.hasStatements_=!1!==a.hasStatements)||this.removeInput("STACK");var b=[],c=[],e=[];if(a.params)for(var d=0;d<a.params.length;d++){var k=a.params[d];b.push(k.name);c.push(k.id);e.push(k.argId)}this.updateShape_(b,c,e)},updateShape_:function(a,b,c){if(a.length!=b.length)throw Error("names and varIds must have the same length.");for(var e=this.argData_.length-1;0<=e;e--)this.removeArg_(this.argData_[e].argId);this.argData_=[];e=b.length;for(var d=0;d<e;d++)this.addArg_(a[d],b[d],c[d]);Blockly.Procedures.mutateCallers(this)},plus:function(){this.addArg_();Blockly.Procedures.mutateCallers(this)},minus:function(a){this.argData_.length&&(this.removeArg_(a),Blockly.Procedures.mutateCallers(this))},addArg_:function(a,b,c){a=void 0===a?null:a;b=void 0===b?null:b;c=void 0===c?null:c;if(!this.argData_.length){var e=new Blockly.FieldLabel(Blockly.Msg.PROCEDURES_BEFORE_PARAMS);this.getInput("TOP").appendField(e,"WITH")}e=this.argData_.map(function(d){return d.model.name});a=a||Blockly.Variables.generateUniqueNameFromOptions(Blockly.Procedures.DEFAULT_ARG,e);b=Blockly.Variables.getOrCreateVariablePackage(this.workspace,b,a,"");c=c||Blockly.utils.idGenerator.genUid();this.addVarInput_(a,c);this.getInput("STACK")?this.moveInputBefore(c,"STACK"):this.moveInputBefore(c,"RETURN");this.argData_.push({model:b,argId:c})},removeArg_:function(a){this.removeInput(a,!0)&&(1==this.argData_.length&&this.getInput("TOP").removeField("WITH"),this.argData_=this.argData_.filter(function(b){return b.argId!=a}))},addVarInput_:function(a,b){a=new Blockly.FieldTextInput(a,this.validator_);a.onFinishEditing_=this.finishEditing_.bind(a);a.varIdsToDelete_=[];a.preEditVarModel_=null;this.appendDummyInput(b).setAlign(Blockly.ALIGN_RIGHT).appendField(g(b)).appendField(Blockly.Msg.PROCEDURE_VARIABLE).appendField(a,b)},validator_:function(a){var b=this,c=this.getSourceBlock(),e=c.workspace,d=c.argData_,k=c.argData_.find(function(l){return l.argId==b.name}),n=k.model.getId();a=a.replace(/[\s\xa0]+/g," ").trim();var r=a.toLowerCase(),t=function(l){return l.argId==b.name||r!=l.model.name.toLowerCase()},u=function(){return e.getVariableUsesById(n).every(function(l){return l.id==c.id||l.getProcedureCall&&l.getProcedureCall()==c.getProcedureDef()[0]})};if(!a||!d.every(t))return this.preEditVarModel_&&(k.model=this.preEditVarModel_,this.preEditVarModel_=null),Blockly.Procedures.mutateCallers(c),null;this.varIdsToDelete_.length||(this.preEditVarModel_=k.model,u()&&this.varIdsToDelete_.push(n));(d=e.getVariable(a,""))?d.name!=a&&e.renameVariableById(d.getId(),a):(d=e.createVariable(a,""),this.varIdsToDelete_.push(d.getId()));d.getId()!=n&&(k.model=d);Blockly.Procedures.mutateCallers(c);return a},finishEditing_:function(a){var b=this,c=this.getSourceBlock(),e=c.argData_.find(function(d){return d.argId==b.name}).model.getId();this.varIdsToDelete_.forEach(function(d){d!=e&&c.workspace.deleteVariableById(d)});this.varIdsToDelete_.length=0;this.preEditVarModel_=null}},function(){this.argData_=[];this.hasStatements_=!0;this.getInput("TOP").insertFieldAt(0,m(),"PLUS")});Blockly.Extensions.register("procedure_rename",function(){this.getField("NAME").setValidator(Blockly.Procedures.rename)});Blockly.Extensions.register("procedure_vars",function(){this.mixin({getVars:function(){return this.argData_.map(function(a){return a.model.name})},getVarModels:function(){return this.argData_.map(function(a){return a.model})},renameVarById:function(a,b){var c=this.argData_.find(function(d){return d.model.getId()==a});if(c){var e=this.workspace.getVariableById(b);this.addVarInput_(e.name,b);this.moveInputBefore(b,a);this.removeInput(a);c.model=e;Blockly.Procedures.mutateCallers(this)}},updateVarName:function(a){var b=a.getId(),c=this.argData_.find(function(e){return e.model.getId()==b});c&&(this.setFieldValue(a.name,c.argId),c.model=a)}},!0)})}();!function(){Blockly.Extensions.isRegistered("text_join_mutator")&&Blockly.Extensions.unregister("text_join_mutator");Blockly.Extensions.registerMutator("text_join_mutator",{itemCount_:0,mutationToDom:function(){var a=Blockly.utils.xml.createElement("mutation");a.setAttribute("items",this.itemCount_);return a},domToMutation:function(a){a=parseInt(a.getAttribute("items"),10);this.updateShape_(a)},saveExtraState:function(){return{itemCount:this.itemCount_}},loadExtraState:function(a){this.updateShape_(a.itemCount)},updateShape_:function(a){for(;this.itemCount_<a;)this.addPart_();for(;this.itemCount_>a;)this.removePart_();this.updateMinus_()},plus:function(){this.addPart_();this.updateMinus_()},minus:function(){0!=this.itemCount_&&(this.removePart_(),this.updateMinus_())},addPart_:function(){0==this.itemCount_?(this.getInput("EMPTY")&&this.removeInput("EMPTY"),this.topInput_=this.appendValueInput("ADD"+this.itemCount_).appendField(m(),"PLUS").appendField(Blockly.Msg.TEXT_JOIN_TITLE_CREATEWITH)):this.appendValueInput("ADD"+this.itemCount_);this.itemCount_++},removePart_:function(){this.itemCount_--;this.removeInput("ADD"+this.itemCount_);0==this.itemCount_&&(this.topInput_=this.appendDummyInput("EMPTY").appendField(m(),"PLUS").appendField(this.newQuote_(!0)).appendField(this.newQuote_(!1)))},updateMinus_:function(){var a=this.getField("MINUS");!a&&0<this.itemCount_?this.topInput_.insertFieldAt(1,g(),"MINUS"):a&&1>this.itemCount_&&this.topInput_.removeField("MINUS")}},function(){Blockly.Extensions.apply("text_quotes",this,!1);this.updateShape_(2)})}()}()}();